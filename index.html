<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Editor simple de beneficios</title>
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color-scheme: light;
    }
    body {
      margin: 0;
      padding: 24px;
      background: #f5f5f7;
      color: #111;
    }
    .shell {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
    }
    h1 {
      margin: 0 0 16px;
      font-size: 24px;
    }
    .controls {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 16px;
    }
    .controls .buttons,
    .controls .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    .controls .filters label {
      display: flex;
      flex-direction: column;
      font-size: 13px;
      color: #374151;
      gap: 4px;
    }
    button {
      border: none;
      border-radius: 8px;
      padding: 10px 18px;
      font-size: 14px;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111;
    }
    button:disabled,
    select:disabled {
      opacity: .5;
      cursor: not-allowed;
    }
    select {
      border-radius: 8px;
      border: 1px solid #d1d5db;
      padding: 6px 10px;
      font-size: 14px;
      background: #fff;
    }
    .status {
      flex: 1;
      min-height: 24px;
      font-size: 14px;
      color: #555;
    }
    .status[data-kind="error"] { color: #b91c1c; }
    .status[data-kind="success"] { color: #15803d; }
    .muted { color: #6b7280; font-size: 13px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    th, td {
      border-bottom: 1px solid #e5e7eb;
      padding: 10px;
      text-align: left;
      vertical-align: middle;
    }
    th { background: #f3f4f6; font-weight: 600; }
    tbody tr:hover { background: #f9fafb; }
    .actions button {
      margin-right: 6px;
      padding: 6px 12px;
      font-size: 13px;
    }
    .empty {
      text-align: center;
      padding: 40px 0;
      color: #6b7280;
    }
    a.link {
      color: #2563eb;
      text-decoration: none;
      word-break: break-all;
    }
    .image-wrap {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }
    .image-wrap img {
      width: 180px;
      max-height: 140px;
      object-fit: cover;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      box-shadow: 0 8px 18px rgba(15,23,42,0.15);
      cursor: zoom-in;
      background: #0f172a;
    }
    /* Modal */
    .modal[hidden] { display: none; }
    .modal {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(15, 23, 42, 0.7);
      padding: 24px;
      z-index: 100;
    }
    .modal figure {
      margin: 0;
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      max-width: 90vw;
      max-height: 90vh;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .modal img {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 8px;
      background: #0f172a;
    }
    .modal .close {
      align-self: flex-end;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #111;
    }
    .modal figcaption {
      font-size: 15px;
    }
  </style>
</head>
<body>
  <main class="shell">
    <h1>Editor simple de beneficios</h1>
    <div class="controls">
      <div class="buttons">
        <button id="btnPick">Elegir archivo JSON</button>
        <button id="btnReload" class="secondary" disabled>Releer archivo</button>
      </div>
      <div class="filters">
        <label>
          Categoría
          <select id="filterCat">
            <option value="all">Todas</option>
          </select>
        </label>
        <label>
          Provincia
          <select id="filterProv">
            <option value="all">Todas</option>
          </select>
        </label>
        <button id="btnResetFilters" class="secondary">Limpiar filtros</button>
      </div>
      <div class="status" id="status">Mostrando datos en modo lectura. Elegí el archivo para poder guardar.</div>
    </div>
    <div class="status" id="fileLabel"></div>
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Título</th>
            <th>Link</th>
            <th>Categoría</th>
            <th>Provincia</th>
            <th>Imagen</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody id="benefitsBody">
          <tr><td colspan="7" class="empty">No hay datos cargados.</td></tr>
        </tbody>
      </table>
    </div>
  </main>

  <div class="modal" id="imageModal" hidden aria-hidden="true">
    <figure>
      <button class="close" type="button" data-action="close-modal" aria-label="Cerrar">×</button>
      <img id="modalImage" src="" alt="Imagen del beneficio" />
      <figcaption id="modalCaption"></figcaption>
    </figure>
  </div>

  <script type="module">
    const CATEGORIES = [
      'Alojamiento',
      'Gastronomía',
      'Excursiones y Actividades',
      'Transporte',
      'Retail',
      'Comercio',
      'Servicios',
      'Deportes',
      'desconocida'
    ];

    const PROVINCES = [
      'Buenos Aires',
      'CABA',
      'Catamarca',
      'Chaco',
      'Chubut',
      'Córdoba',
      'Corrientes',
      'Entre Ríos',
      'Formosa',
      'Jujuy',
      'La Pampa',
      'La Rioja',
      'Mendoza',
      'Misiones',
      'Neuquén',
      'Río Negro',
      'Salta',
      'San Juan',
      'San Luis',
      'Santa Cruz',
      'Santa Fe',
      'Santiago del Estero',
      'Tierra del Fuego',
      'Tucumán'
    ];

    const state = {
      rows: [],
      handle: null,
      filterCat: 'all',
      filterProv: 'all'
    };

    const $ = (sel) => document.querySelector(sel);
    const tbody = $('#benefitsBody');
    const statusBox = $('#status');
    const fileLabel = $('#fileLabel');
    const btnReload = $('#btnReload');
    const filterCat = $('#filterCat');
    const filterProv = $('#filterProv');
    const btnResetFilters = $('#btnResetFilters');
    const modal = $('#imageModal');
    const modalImg = $('#modalImage');
    const modalCaption = $('#modalCaption');

    async function init() {
      try {
        const res = await fetch('beneficios_final.json', { cache: 'no-store' });
        if (res.ok) {
          const data = await res.json();
          if (Array.isArray(data)) {
            state.rows = data;
            render();
          }
        }
      } catch (err) {
        console.warn('No se pudo precargar beneficios_final.json', err);
      }
    }

    function render() {
      populateFilters();
      const filtered = getFilteredRows();
      if (!filtered.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="empty">No hay datos cargados.</td></tr>';
        return;
      }
      tbody.innerHTML = filtered.map((item, idx) => {
        const originalIndex = state.rows.indexOf(item);
        const link = item.url || '';
        const category = item.category || '';
        const province = item.province || '';
        const image = getImage(item);
        const catSelect = `
          <select data-action="category" data-idx="${originalIndex}">
            ${buildCategoryOptions(category)}
          </select>
        `;
        const provSelect = `
          <select data-action="province" data-idx="${originalIndex}">
            ${buildProvinceOptions(province)}
          </select>
        `;
        const imageCell = image
          ? `<div class="image-wrap">
               <img src="${escapeAttr(image)}" alt="${escapeAttr(item.title || 'Imagen')}" data-action="image" data-idx="${originalIndex}" />
               <small class="muted">Click para ampliar</small>
             </div>`
          : '<span class="muted">Sin imagen</span>';
        return `
          <tr>
            <td>${idx + 1}</td>
            <td>${escapeHtml(item.title || '')}</td>
            <td><a class="link" href="${escapeAttr(link)}" target="_blank" rel="noopener noreferrer">${escapeHtml(link)}</a></td>
            <td>${catSelect}</td>
            <td>${provSelect}</td>
            <td>${imageCell}</td>
            <td class="actions">
              <button data-action="edit" data-idx="${originalIndex}">Modificar</button>
              <button data-action="delete" data-idx="${originalIndex}" class="secondary">Eliminar</button>
            </td>
          </tr>
        `;
      }).join('');
    }

    function populateFilters() {
      const categories = uniqueValues(state.rows.map(r => r.category));
      const provinces = uniqueValues(state.rows.map(r => r.province));
      fillFilter(filterCat, categories, state.filterCat, 'Categorías');
      fillFilter(filterProv, provinces, state.filterProv, 'Provincias');
    }

    function fillFilter(selectEl, values, current, label) {
      const opts = ['all', ...values];
      selectEl.innerHTML = opts.map(value => {
        const isAll = value === 'all';
        const optionLabel = isAll ? `Todas` : (value || 'Sin dato');
        const selected = value === current ? ' selected' : '';
        return `<option value="${escapeAttr(value || '')}"${selected}>${escapeHtml(optionLabel)}</option>`;
      }).join('');
      selectEl.value = current;
      if (selectEl.value !== current) {
        selectEl.value = 'all';
        if (selectEl === filterCat) state.filterCat = 'all';
        if (selectEl === filterProv) state.filterProv = 'all';
      }
    }

    function uniqueValues(list) {
      const normalized = new Map();
      list.forEach(value => {
        const key = normalizeValue(value);
        if (!key) return;
        if (!normalized.has(key)) normalized.set(key, value);
      });
      return Array.from(normalized.values()).sort((a, b) => {
        return normalizeValue(a).localeCompare(normalizeValue(b));
      });
    }

    function normalizeValue(value) {
      return (value || '').toString().trim().toLowerCase();
    }

    function getFilteredRows() {
      const filterCatNorm = normalizeValue(state.filterCat);
      const filterProvNorm = normalizeValue(state.filterProv);
      return state.rows.filter(row => {
        const catMatches = state.filterCat === 'all' || normalizeValue(row.category) === filterCatNorm;
        const provMatches = state.filterProv === 'all' || normalizeValue(row.province) === filterProvNorm;
        return catMatches && provMatches;
      });
    }

    function buildCategoryOptions(current = '') {
      const unique = [];
      const seen = new Set();
      const list = [''].concat(CATEGORIES, current ? [current] : []);
      list.forEach(cat => {
        const key = (cat || '').toLowerCase();
        if (seen.has(key)) return;
        seen.add(key);
        unique.push(cat);
      });
      return unique.map(cat => {
        const selected = cat === current ? ' selected' : '';
        const label = cat || '- Seleccionar -';
        return `<option value="${escapeAttr(cat || '')}"${selected}>${escapeHtml(label)}</option>`;
      }).join('');
    }

    function buildProvinceOptions(current = '') {
      const unique = [];
      const seen = new Set();
      const list = [''].concat(PROVINCES, current ? [current] : []);
      list.forEach(prov => {
        const key = normalizeValue(prov);
        if (seen.has(key)) return;
        seen.add(key);
        unique.push(prov);
      });
      return unique.map(prov => {
        const selected = prov === current ? ' selected' : '';
        const label = prov || '- Seleccionar -';
        return `<option value="${escapeAttr(prov || '')}"${selected}>${escapeHtml(label)}</option>`;
      }).join('');
    }

    function getImage(item) {
      return item.imageUrl || item.imagen_url || '';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    function escapeAttr(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML.replace(/"/g, '&quot;');
    }

    async function pickFile() {
      if (!window.showOpenFilePicker) {
        alert('Este navegador no soporta la edición directa. Usá Chrome o Edge.');
        return;
      }
      try {
        const [handle] = await window.showOpenFilePicker({
          types: [{ description: 'JSON', accept: { 'application/json': ['.json'] } }],
          excludeAcceptAllOption: false,
          multiple: false
        });
        state.handle = handle;
        fileLabel.textContent = `Archivo: ${handle.name}`;
        btnReload.disabled = false;
        await loadFromHandle();
        setStatus('Archivo listo. Las ediciones se guardan al instante.', 'success');
      } catch (err) {
        if (err.name !== 'AbortError') {
          setStatus('No se pudo abrir el archivo: ' + err.message, 'error');
        }
      }
    }

    async function ensurePermission() {
      if (!state.handle) {
        alert('Primero elegí el archivo JSON.');
        setStatus('Necesitás elegir el archivo JSON para guardar cambios.', 'error');
        return false;
      }
      const perm = await state.handle.queryPermission({ mode: 'readwrite' });
      if (perm === 'granted') return true;
      const req = await state.handle.requestPermission({ mode: 'readwrite' });
      if (req !== 'granted') {
        setStatus('Permiso para editar denegado.', 'error');
      }
      return req === 'granted';
    }

    async function loadFromHandle() {
      if (!state.handle) return;
      try {
        const file = await state.handle.getFile();
        const text = await file.text();
        const data = JSON.parse(text);
        if (!Array.isArray(data)) throw new Error('El JSON debe ser un array.');
        state.rows = data;
        render();
      } catch (err) {
        setStatus('No se pudo leer el archivo: ' + err.message, 'error');
      }
    }

    async function saveToFile() {
      if (!state.handle) return;
      const writable = await state.handle.createWritable();
      await writable.write(JSON.stringify(state.rows, null, 2));
      await writable.close();
    }

    async function editRow(idx) {
      if (!(await ensurePermission())) return;
      const item = state.rows[idx];
      const title = prompt('Título', item.title || '');
      if (title === null) return;
      const url = prompt('URL', item.url || '');
      if (url === null) return;
      const province = prompt('Provincia', item.province || '');
      if (province === null) return;
      Object.assign(item, {
        title: title.trim(),
        url: url.trim(),
        province: province.trim() || null
      });
      await saveToFile();
      render();
      setStatus('Beneficio actualizado.', 'success');
    }

    async function deleteRow(idx) {
      if (!(await ensurePermission())) return;
      if (!confirm('¿Eliminar este beneficio?')) return;
      state.rows.splice(idx, 1);
      await saveToFile();
      render();
      setStatus('Beneficio eliminado.', 'success');
    }

    async function updateCategory(idx, value) {
      if (!(await ensurePermission())) {
        render();
        return;
      }
      state.rows[idx].category = value || null;
      await saveToFile();
      setStatus('Categoría actualizada.', 'success');
    }

    async function updateProvince(idx, value) {
      if (!(await ensurePermission())) {
        render();
        return;
      }
      state.rows[idx].province = value || null;
      await saveToFile();
      setStatus('Provincia actualizada.', 'success');
    }

    function showImage(idx) {
      const row = state.rows[idx];
      const img = getImage(row);
      if (!img) {
        setStatus('Este beneficio no tiene imagen.', 'error');
        return;
      }
      modalImg.src = img;
      modalCaption.textContent = row.title || img;
      modal.hidden = false;
      modal.setAttribute('aria-hidden', 'false');
    }

    function hideModal() {
      modal.hidden = true;
      modal.setAttribute('aria-hidden', 'true');
      modalImg.src = '';
      modalCaption.textContent = '';
    }

    function setStatus(message, kind = 'info') {
      statusBox.textContent = message;
      statusBox.dataset.kind = kind;
    }

    document.getElementById('btnPick').addEventListener('click', pickFile);
    btnReload.addEventListener('click', loadFromHandle);

    tbody.addEventListener('click', (event) => {
      const el = event.target.closest('[data-action]');
      if (!el) return;
      const idx = Number(el.dataset.idx);
      if (Number.isNaN(idx)) return;
      if (el.dataset.action === 'edit') {
        editRow(idx);
      } else if (el.dataset.action === 'delete') {
        deleteRow(idx);
      } else if (el.dataset.action === 'image') {
        showImage(idx);
      }
    });

    tbody.addEventListener('change', async (event) => {
      const select = event.target.closest('select[data-action]');
      if (!select) return;
      const idx = Number(select.dataset.idx);
      if (Number.isNaN(idx)) return;
      if (select.dataset.action === 'category') {
        await updateCategory(idx, select.value);
      } else if (select.dataset.action === 'province') {
        await updateProvince(idx, select.value);
      }
      render();
    });

    filterCat.addEventListener('change', (event) => {
      const value = event.target.value;
      state.filterCat = value === 'all' ? 'all' : value;
      render();
    });
    filterProv.addEventListener('change', (event) => {
      const value = event.target.value;
      state.filterProv = value === 'all' ? 'all' : value;
      render();
    });
    btnResetFilters.addEventListener('click', () => {
      state.filterCat = 'all';
      state.filterProv = 'all';
      filterCat.value = 'all';
      filterProv.value = 'all';
      render();
    });

    modal.addEventListener('click', (event) => {
      if (event.target.dataset.action === 'close-modal' || event.target === modal) {
        hideModal();
      }
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !modal.hidden) hideModal();
    });

    init();
  </script>
</body>
</html>
